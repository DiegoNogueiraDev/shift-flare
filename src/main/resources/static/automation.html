<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Automação - Shift-Flare</title>
  <meta name="description" content="Automação - Crie scripts de automação inteligentes para seus processos">
  
  <!-- Bootstrap CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="css/bootstrap-icons.css">
  
  <!-- Google Fonts - Poppins -->
  <link rel="stylesheet" href="css/poppins.css">
  
  <!-- Highlight.js para syntax highlighting -->
  <link rel="stylesheet" href="css/highlight/atom-one-dark.min.css">
  <script src="js/highlight.min.js"></script>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- Cliente JavaScript para a API -->
  <script src="js/ai-client.js"></script>
  
  <!-- Favicon -->
  <link rel="icon" href="img/flare-logo.png" type="image/png">
  
  <style>
    .chat-container {
      height: 65vh;
      overflow-y: auto;
      background-color: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .message {
      padding: 15px;
      margin: 10px;
      border-radius: 8px;
      max-width: 85%;
    }
    
    .user-message {
      background-color: #e6f3ff;
      margin-left: auto;
    }
    
    .bot-message {
      background: var(--gradient);
      color: white;
      margin-right: auto;
    }
    
    .code-input {
      border-radius: 8px;
      min-height: 150px;
      font-family: monospace;
      resize: vertical;
    }
    
    .feedback-icons {
      color: white;
      cursor: pointer;
    }
    
    .feedback-icons i:hover {
      transform: scale(1.2);
    }
    
    .loading-dots {
      display: inline-flex;
    }
    
    .loading-dots span {
      width: 8px;
      height: 8px;
      margin: 0 3px;
      background-color: white;
      border-radius: 50%;
      display: inline-block;
      animation: loading 1.4s infinite ease-in-out both;
    }
    
    .loading-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }
    
    .loading-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }
    
    @keyframes loading {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    /* Estilos para testes gerados */
    .test-step {
      display: flex;
      align-items: flex-start;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 6px;
      background-color: rgba(255,255,255,0.1);
    }
    
    .step-number {
      min-width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background-color: rgba(255,255,255,0.3);
      margin-right: 12px;
      font-weight: 500;
    }
    
    .step-content {
      flex: 1;
    }
    
    .action-line {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .action-icon {
      margin-right: 10px;
      font-size: 1.1rem;
    }
    
    .selector-badge {
      font-size: 0.8em;
      padding: 2px 8px;
      border-radius: 12px;
      background-color: rgba(255,255,255,0.2);
      margin-left: 8px;
    }
    
    .test-details {
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      background-color: rgba(255,255,255,0.1);
    }
    
    .detail-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .detail-icon {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <!-- Navbar Component -->
  <div data-component="navbar" data-activate="true"></div>
  
  <!-- Main Content -->
  <main class="pt-5">
    <div class="container mt-5 pt-3">
      <h1 class="text-center fw-bold mb-3">Automação Inteligente</h1>
      <p class="text-center mb-5">Crie scripts de automação robustos utilizando inteligência artificial</p>
      
      <div class="row">
        <div class="col-lg-8 mx-auto">
          <!-- Chat Container -->
          <div class="chat-container p-3 mb-4" id="chatContainer">
            <!-- Mensagem do bot inicial -->
            <div class="message bot-message">
              <h5>Assistente de Automação</h5>
              <p>Olá! Descreva abaixo o processo que você deseja automatizar. Você pode escrever em linguagem natural, 
              incluindo detalhes sobre a aplicação, ações a serem executadas e validações necessárias.</p>
              <p>Exemplo: "Preciso criar um teste para entrar no sistema ERP, navegar até o módulo de vendas, preencher um novo pedido e verificar se o pedido foi criado com sucesso."</p>
            </div>
            
            <!-- Mensagens dinâmicas aparecerão aqui -->
          </div>
          
          <!-- Input do usuário -->
          <div class="code-input-container mb-4">
            <textarea class="form-control code-input" id="codeInput" 
                      placeholder="Descreva o processo que deseja automatizar..." rows="6"></textarea>
          </div>
          
          <!-- Botões de envio e opções -->
          <div class="d-flex justify-content-between mb-5">
            <div>
              <select class="form-select me-2" id="frameworkSelect">
                <option value="selenium">Selenium WebDriver</option>
                <option value="cypress">Cypress</option>
                <option value="playwright">Playwright</option>
                <option value="appium">Appium (Mobile)</option>
              </select>
            </div>
            <div>
              <button class="btn btn-outline-secondary me-2" id="clearBtn">Limpar</button>
              <button class="btn btn-primary" id="generateBtn">
                <i class="bi bi-gear me-2"></i>Gerar Automação
              </button>
            </div>
          </div>
          
          <!-- Feature Information -->
          <div class="card mb-5">
            <div class="card-header animate-gradient text-white">
              <h3 class="h5 mb-0">Recursos de Automação Inteligente</h3>
            </div>
            <div class="card-body">
              <ul class="mb-0">
                <li><strong>Geração de scripts</strong> - Criação de scripts de automação a partir de descrições em linguagem natural</li>
                <li><strong>Seletores robustos</strong> - Utilização da tecnologia XPath-Prediction para seletores que resistem a mudanças</li>
                <li><strong>Multi-framework</strong> - Suporte para Selenium, Cypress, Playwright e Appium</li>
                <li><strong>Cenários complexos</strong> - Capacidade de gerar casos de teste para fluxos complexos com múltiplas etapas</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Footer Component -->
  <div data-component="footer"></div>
  
  <!-- Bootstrap Bundle with Popper -->
  <script src="js/bootstrap.bundle.min.js"></script>
  
  <!-- Component Loader Script -->
  <script src="js/component-loader.js"></script>
  
  <!-- Utilities Script -->
  <script src="js/utils.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chatContainer = document.getElementById('chatContainer');
      const codeInput = document.getElementById('codeInput');
      const frameworkSelect = document.getElementById('frameworkSelect');
      const generateBtn = document.getElementById('generateBtn');
      const clearBtn = document.getElementById('clearBtn');
      
      // Inicializa syntax highlighting
      hljs.highlightAll();
      
      // Função para gerar automação usando a API real
      const generateAutomationWithAPI = async (description, framework) => {
        // Mostra a mensagem do usuário
        addUserMessage(description);
        
        // Mostra indicador de carregamento
        addLoadingIndicator();
        
        try {
          // Chama a API real
          const response = await generateAutomation(description, framework);
          
          // Remove indicador de carregamento
          removeLoadingIndicator();
          
          if (response.success) {
            // Processa a resposta
            const content = response.response;
            
            // Cria um objeto de resposta formatado para exibição
            const formattedResponse = {
              success: true,
              testName: extractTestName(content),
              framework: framework,
              description: extractDescription(content),
              steps: extractTestSteps(content),
              generatedCode: extractCode(content)
            };
            
            // Adiciona resposta do bot
            addBotResponse(formattedResponse);
          } else {
            // Em caso de erro
            addErrorMessage(response.error || "Ocorreu um erro ao gerar o script de automação.");
          }
        } catch (error) {
          // Remove indicador de carregamento
          removeLoadingIndicator();
          
          // Adiciona mensagem de erro
          addErrorMessage("Erro ao conectar com o serviço de automação. Por favor, tente novamente mais tarde.");
          console.error("Erro ao gerar automação:", error);
        }
      };
      
      // Extrai o nome do teste do texto da resposta
      const extractTestName = (content) => {
        const nameRegex = /(?:Nome do teste|Título|Teste)[:]\s*(.*?)(?=\n|$)/i;
        const match = content.match(nameRegex);
        return match ? match[1].trim() : "Automação de Processo";
      };
      
      // Extrai a descrição do texto da resposta
      const extractDescription = (content) => {
        const descRegex = /(?:Descrição|Cenário)[:]\s*(.*?)(?=\n\d|\n\*)/is;
        const match = content.match(descRegex);
        return match ? match[1].trim() : "Automação do processo descrito";
      };
      
      // Extrai etapas do teste do texto da resposta
      const extractTestSteps = (content) => {
        const steps = [];
        
        // Tenta encontrar a seção de etapas ou passos do teste
        let stepsSection = "";
        if (content.includes("Etapas do teste")) {
          const regex = /Etapas do teste.*?:(.*?)(?=\d\.\s*Código|$)/is;
          const match = content.match(regex);
          stepsSection = match ? match[1] : content;
        } else {
          stepsSection = content;
        }
        
        // Tenta extrair passos enumerados
        const stepsRegex = /(\d+)[.)\s]+([^\n]+)/g;
        let match;
        while ((match = stepsRegex.exec(stepsSection)) !== null) {
          const stepNumber = parseInt(match[1]);
          const stepText = match[2].trim();
          
          // Tenta determinar o tipo de ação baseado no texto
          let action = determineActionType(stepText);
          
          // Cria um objeto de passo
          const step = {
            number: stepNumber,
            action: action,
            description: stepText,
            selector: extractSelector(stepText)
          };
          
          steps.push(step);
        }
        
        // Se não achou nenhum passo, retorna pelo menos alguns passos genéricos
        if (steps.length === 0) {
          return [
            { 
              number: 1, 
              action: "navigate", 
              description: "Navegar para o sistema", 
              selector: null 
            },
            { 
              number: 2, 
              action: "input", 
              description: "Inserir dados necessários", 
              selector: null 
            },
            { 
              number: 3, 
              action: "click", 
              description: "Submeter o formulário", 
              selector: null 
            }
          ];
        }
        
        return steps;
      };
      
      // Determina o tipo de ação baseado no texto do passo
      const determineActionType = (stepText) => {
        const text = stepText.toLowerCase();
        
        if (text.includes("naveg") || text.includes("abrir") || text.includes("acessa")) {
          return "navigate";
        } else if (text.includes("clicar") || text.includes("selecionar") || text.includes("pressionar")) {
          return "click";
        } else if (text.includes("preencher") || text.includes("digitar") || text.includes("inserir")) {
          return "input";
        } else if (text.includes("aguardar") || text.includes("esperar")) {
          return "wait";
        } else if (text.includes("verificar") || text.includes("validar") || text.includes("confirmar")) {
          return "assertion";
        }
        
        return "input"; // Padrão
      };
      
      // Tenta extrair um seletor do texto do passo
      const extractSelector = (stepText) => {
        // Tenta encontrar um seletor HTML
        const selectorRegex = /(id|class|name|css|xpath)[\s=:]+["']?([^"'\s]+)["']?/i;
        const match = stepText.match(selectorRegex);
        
        if (match) {
          const type = match[1].toLowerCase();
          const value = match[2];
          
          // Formata o seletor de acordo com o tipo
          if (type === 'id') return `#${value}`;
          if (type === 'class') return `.${value}`;
          if (type === 'name') return `name=${value}`;
          if (type === 'xpath') return `xpath=${value}`;
          return value;
        }
        
        // Tenta encontrar textos com aspas que possam ser labels ou botões
        const quoteRegex = /["']([^"']+)["']/;
        const quoteMatch = stepText.match(quoteRegex);
        
        if (quoteMatch) {
          const text = quoteMatch[1];
          return `xpath=//*[contains(text(), '${text}')]`;
        }
        
        return null;
      };
      
      // Extrai o código do texto da resposta
      const extractCode = (content) => {
        const codeRegex = /```(?:\w*)([\s\S]*?)```/;
        const match = content.match(codeRegex);
        return match ? match[1].trim() : 
               "// Não foi possível extrair o código da resposta.\n// Consulte o assistente para mais detalhes.";
      };
      
      // Adiciona mensagem do usuário ao chat
      const addUserMessage = (text) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user-message';
        
        const textParagraph = document.createElement('p');
        textParagraph.className = 'mb-0';
        textParagraph.textContent = text;
        
        messageDiv.appendChild(textParagraph);
        chatContainer.appendChild(messageDiv);
        
        // Rola para a última mensagem
        chatContainer.scrollTop = chatContainer.scrollHeight;
      };
      
      // Adiciona resposta do bot ao chat
      const addBotResponse = (response) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot-message';
        
        const title = document.createElement('h5');
        title.textContent = 'Automação Gerada';
        messageDiv.appendChild(title);
        
        const summary = document.createElement('p');
        summary.textContent = response.description;
        messageDiv.appendChild(summary);
        
        // Adiciona detalhes do teste
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'test-details';
        
        detailsDiv.innerHTML = `
          <div class="detail-item">
            <i class="bi bi-journal-code detail-icon"></i>
            <strong>Nome do Teste:</strong> ${response.testName}
          </div>
          <div class="detail-item">
            <i class="bi bi-gear detail-icon"></i>
            <strong>Framework:</strong> ${getFrameworkDisplayName(response.framework)}
          </div>
          <div class="detail-item">
            <i class="bi bi-list-ol detail-icon"></i>
            <strong>Passos:</strong> ${response.steps.length}
          </div>
        `;
        
        messageDiv.appendChild(detailsDiv);
        
        // Adiciona etapas do teste
        const stepsTitle = document.createElement('h6');
        stepsTitle.className = 'mt-4 mb-3';
        stepsTitle.textContent = 'Etapas do Teste:';
        messageDiv.appendChild(stepsTitle);
        
        const stepsContainer = document.createElement('div');
        stepsContainer.className = 'mb-3';
        
        response.steps.forEach(step => {
          const stepDiv = document.createElement('div');
          stepDiv.className = 'test-step';
          
          const stepNumber = document.createElement('div');
          stepNumber.className = 'step-number';
          stepNumber.textContent = step.number;
          
          const stepContent = document.createElement('div');
          stepContent.className = 'step-content';
          
          const actionLine = document.createElement('div');
          actionLine.className = 'action-line';
          
          const actionIcon = document.createElement('i');
          actionIcon.className = `bi ${getActionIcon(step.action)} action-icon`;
          
          const actionText = document.createElement('span');
          actionText.textContent = step.description;
          
          actionLine.appendChild(actionIcon);
          actionLine.appendChild(actionText);
          
          if (step.selector) {
            const selectorBadge = document.createElement('span');
            selectorBadge.className = 'selector-badge';
            selectorBadge.textContent = step.selector;
            actionLine.appendChild(selectorBadge);
          }
          
          stepContent.appendChild(actionLine);
          
          stepDiv.appendChild(stepNumber);
          stepDiv.appendChild(stepContent);
          stepsContainer.appendChild(stepDiv);
        });
        
        messageDiv.appendChild(stepsContainer);
        
        // Adiciona código gerado
        const codeTitle = document.createElement('h6');
        codeTitle.className = 'mt-4 mb-2';
        codeTitle.textContent = 'Código Gerado:';
        messageDiv.appendChild(codeTitle);
        
        const codeContainer = document.createElement('pre');
        codeContainer.className = 'diff-container p-0 m-0';
        
        const language = getLanguageForFramework(response.framework);
        
        const codeElement = document.createElement('code');
        codeElement.className = language;
        codeElement.textContent = response.generatedCode;
        
        codeContainer.appendChild(codeElement);
        messageDiv.appendChild(codeContainer);
        
        // Aplicar syntax highlighting depois de adicionar ao DOM
        setTimeout(() => {
          hljs.highlightElement(codeElement);
        }, 0);
        
        // Adiciona ícones de feedback
        const feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'feedback-icons mt-3 text-end';
        feedbackDiv.innerHTML = `
          <i class="bi bi-hand-thumbs-up me-3" title="Útil"></i>
          <i class="bi bi-hand-thumbs-down" title="Não Útil"></i>
        `;
        messageDiv.appendChild(feedbackDiv);
        
        chatContainer.appendChild(messageDiv);
        
        // Rola para a última mensagem
        chatContainer.scrollTop = chatContainer.scrollHeight;
      };
      
      // Adiciona mensagem de erro
      const addErrorMessage = (errorText) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot-message';
        
        const title = document.createElement('h5');
        title.textContent = 'Erro';
        messageDiv.appendChild(title);
        
        const errorMessage = document.createElement('p');
        errorMessage.textContent = errorText;
        messageDiv.appendChild(errorMessage);
        
        chatContainer.appendChild(messageDiv);
        
        // Rola para a última mensagem
        chatContainer.scrollTop = chatContainer.scrollHeight;
      };
      
      // Adiciona indicador de carregamento
      const addLoadingIndicator = () => {
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message bot-message loading-message';
        loadingDiv.innerHTML = `
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        `;
        chatContainer.appendChild(loadingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      };
      
      // Remove indicador de carregamento
      const removeLoadingIndicator = () => {
        const loadingMessage = document.querySelector('.loading-message');
        if (loadingMessage) {
          loadingMessage.remove();
        }
      };
      
      // Retorna ícone para o tipo de ação
      const getActionIcon = (action) => {
        switch(action) {
          case 'navigate': return 'bi-globe';
          case 'click': return 'bi-mouse';
          case 'input': return 'bi-input-cursor-text';
          case 'wait': return 'bi-hourglass-split';
          case 'assertion': return 'bi-check-circle';
          case 'select': return 'bi-list';
          default: return 'bi-code-slash';
        }
      };
      
      // Retorna nome de exibição para o framework
      const getFrameworkDisplayName = (framework) => {
        switch(framework) {
          case 'selenium': return 'Selenium WebDriver (Java)';
          case 'cypress': return 'Cypress (JavaScript)';
          case 'playwright': return 'Playwright (TypeScript)';
          case 'appium': return 'Appium (Java)';
          default: return framework;
        }
      };
      
      // Retorna linguagem para o framework (para highlighting)
      const getLanguageForFramework = (framework) => {
        switch(framework) {
          case 'selenium': return 'java';
          case 'cypress': return 'javascript';
          case 'playwright': return 'typescript';
          case 'appium': return 'java';
          default: return 'javascript';
        }
      };
      
      // Event listeners
      generateBtn.addEventListener('click', () => {
        const description = codeInput.value.trim();
        if (description) {
          generateAutomationWithAPI(description, frameworkSelect.value);
          codeInput.value = '';
        }
      });
      
      clearBtn.addEventListener('click', () => {
        codeInput.value = '';
      });
      
      // Enter para enviar (Ctrl+Enter)
      codeInput.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'Enter') {
          generateBtn.click();
        }
      });
    });
  </script>
</body>
</html> 